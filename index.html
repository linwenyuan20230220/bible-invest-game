<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>è–ç¶“æ¢—æŠ•è³‡æ¨¡æ“¬äº¤æ˜“æ‰€</title>
  <style>
    * { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body { margin: 0; background: #0f172a; color: #e5e7eb; }
    .container { max-width: 1100px; margin: 0 auto; padding: 16px; }
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    header h1 { font-size: 24px; margin: 0; }
    header span { font-size: 12px; color: #9ca3af; }
    .layout { display: grid; grid-template-columns: 340px 1fr; gap: 16px; }
    .card { background: #020617; border-radius: 12px; padding: 16px; border: 1px solid #1f2937; box-shadow: 0 10px 25px rgba(15,23,42,.8); position: relative; }
    .card h2 { margin: 0 0 8px; font-size: 16px; }
    label { font-size: 13px; color: #9ca3af; display: block; margin-bottom: 4px; }
    select, input[type="number"], input[type="text"] { width: 100%; padding: 6px 8px; border-radius: 8px; border: 1px solid #4b5563; background: #020617; color: #e5e7eb; font-size: 14px; outline: none; }
    select:focus, input:focus { border-color: #38bdf8; box-shadow: 0 0 0 1px #38bdf8; }
    .field { margin-bottom: 10px; }
    .inline { display: flex; gap: 8px; align-items: center; }
    .inline > div { flex: 1; }
    button { border-radius: 999px; border: none; cursor: pointer; font-size: 14px; padding: 6px 12px; font-weight: 500; transition: transform .05s ease, box-shadow .05s ease, background .1s ease; }
    button:active { transform: translateY(1px); box-shadow: none; }
    .btn-buy { background: #22c55e; color: #022c22; box-shadow: 0 0 0 1px rgba(34,197,94,.3), 0 8px 20px rgba(34,197,94,.3); }
    .btn-buy:hover { background: #16a34a; }
    .btn-sell { background: #f97316; color: #1b1306; box-shadow: 0 0 0 1px rgba(249,115,22,.3), 0 8px 20px rgba(249,115,22,.3); }
    .btn-sell:hover { background: #ea580c; }
    .btn-start { background: #38bdf8; color: #0b1120; box-shadow: 0 0 0 1px rgba(56,189,248,.3), 0 8px 20px rgba(56,189,248,.4); width: 100%; margin-top: 6px; }
    .btn-start:disabled { opacity: .6; cursor: default; box-shadow: none; }
    .btn-pause { background: #facc15; color: #1f2937; box-shadow: 0 0 0 1px rgba(250,204,21,.3), 0 8px 20px rgba(250,204,21,.25); width: 100%; margin-top: 6px; }
    .btn-pause:disabled { opacity: .6; cursor: default; box-shadow: none; }

    .btn-secondary {
      background: #a78bfa;
      color: #0b1120;
      box-shadow: 0 0 0 1px rgba(167,139,250,.3), 0 8px 20px rgba(167,139,250,.25);
      width: 100%;
      margin-top: 6px;
    }
    .btn-secondary:hover { background: #8b5cf6; }

    .tag { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 999px; font-size: 11px; background: #111827; border: 1px solid #1f2937; color: #9ca3af; }
    .stats { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 8px; margin-top: 10px; margin-bottom: 4px; }
    .stat { padding: 8px; border-radius: 10px; background: radial-gradient(circle at top left, #1e293b, #020617); border: 1px solid #1f2937; }
    .stat-label { font-size: 12px; color: #9ca3af; margin-bottom: 2px; }
    .stat-value { font-size: 15px; font-weight: 600; }
    .stat-sub { font-size: 11px; color: #6b7280; }
    .table-wrapper { margin-top: 10px; border-radius: 10px; border: 1px solid #1f2937; overflow: hidden; }
    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    thead { background: #020617; }
    th, td { padding: 6px 8px; text-align: right; border-bottom: 1px solid #111827; }
    th:first-child, td:first-child { text-align: left; }
    tbody tr:nth-child(even) td { background: #020617; }
    .pnl-positive { color: #4ade80; }
    .pnl-negative { color: #fca5a5; }
    #chart { width: 100%; border-radius: 12px; border: 1px solid #1f2937; background: radial-gradient(circle at top, #0b1120, #020617); }
    .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .chart-title { font-size: 14px; font-weight: 600; }
    .price-text { font-size: 13px; color: #9ca3af; }
    .price-text span { font-weight: 600; color: #e5e7eb; }
    .log { max-height: 150px; overflow-y: auto; margin-top: 8px; padding-right: 4px; font-size: 11px; line-height: 1.4; }
    .log-entry { color: #9ca3af; border-left: 2px solid #1f2937; padding-left: 6px; margin-bottom: 4px; }
    .hint { font-size: 11px; color: #6b7280; margin-top: 4px; }
    .news-box {
      margin-top: 10px;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid #1f2937;
      background: #020617;
      font-size: 13px;
      line-height: 1.6;
      max-height: 260px;
      overflow-y: auto;
    }
    .news-title { font-size: 12px; color: #9ca3af; margin-bottom: 4px; }
    .news-item {
      font-size: 15px;
      color: #e5e7eb;
      border-left: 3px solid #38bdf8;
      padding-left: 10px;
      margin-bottom: 8px;
    }
    .news-item span { font-size: 11px; color: #9ca3af; margin-right: 4px; }
    @media (max-width: 900px) { .layout { grid-template-columns: 1fr; } }

    .news-overlay {
      position: absolute;
      inset: 0;
      background: rgba(2,6,23,0.92);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
      animation: fadeIn .3s ease;
    }
    .news-overlay.hidden { display: none; }
    .news-overlay-content {
      font-size: 22px;
      line-height: 1.8;
      font-weight: 600;
      text-align: center;
      padding: 24px 28px;
      max-width: 90%;
      border-radius: 16px;
      background: radial-gradient(circle at top, #1e293b, #020617);
      border: 1px solid #38bdf8;
      box-shadow: 0 20px 40px rgba(56,189,248,.25);
    }
    @keyframes fadeIn { from { opacity: 0; transform: scale(.96);} to { opacity: 1; transform: scale(1);} }

    .screen.hidden { display: none; }

    .lb-title { display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .pill { font-size: 11px; color:#9ca3af; border:1px solid #1f2937; padding:2px 8px; border-radius:999px; background:#111827; }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <div>
        <h1>è–ç¶“æ¢—æŠ•è³‡æ¨¡æ“¬äº¤æ˜“æ‰€</h1>
        <span>å…ˆçœ‹ 10 æ ¹éš¨æ©Ÿæ­·å² Kï¼›æŒ‰ã€Œé–‹å§‹ã€å¾Œï¼Œæ¯ç§’ 1 æ ¹åŠ‡æƒ… Kã€‚æ–°èä¸é‡è¤‡æ¨é€ã€‚</span>
      </div>
      <div class="tag">è™›æ“¬è³‡é‡‘ï¼Œå‹¿ç•¶çœŸå¯¦æŠ•è³‡å»ºè­°</div>
    </header>

    <!-- éŠæˆ²å‰ -->
    <div id="screenPre" class="card screen">
      <h2>éŠæˆ²å‰ï¼šè¼¸å…¥ç©å®¶åç¨±</h2>
      <div class="field">
        <label for="playerNameInput">ç©å®¶åç¨±ï¼ˆç”¨æ–¼æ’è¡Œæ¦œï¼‰</label>
        <input id="playerNameInput" type="text" maxlength="16" placeholder="ä¾‹å¦‚ï¼šæ–‡é  / Samuel / ArkTrader" />
        <div class="hint">å»ºè­° 2ï½16 å­—ï¼›åŒåæœƒè¦†è“‹ç‚ºæœ€æ–°çµæœï¼ˆé›²ç«¯æ’è¡Œæ¦œï¼‰ã€‚</div>
      </div>
      <button class="btn-start" id="confirmNameBtn">ç¢ºèªä¸¦é€²å…¥éŠæˆ²</button>
      <div id="preMessage" class="hint"></div>
    </div>

    <!-- éŠæˆ²ä¸­ -->
    <div id="screenGame" class="layout screen hidden">
      <div class="card">
        <h2>ä¸‹å–®å€</h2>

        <div class="field">
          <label for="assetSelect">é¸æ“‡æ¨™çš„</label>
          <select id="assetSelect">
            <option value="A">æ–¹èˆŸé€ èˆ¹é›†åœ˜ï¼ˆARKZï¼‰</option>
            <option value="B">è€¶åˆ©å“¥åŸç‰†é˜²ç¦¦å…¬å¸ï¼ˆWALLï¼‰</option>
            <option value="C">ç´„æ‹¿æµ·åº•è§€å…‰æ§è‚¡ï¼ˆWHALEï¼‰</option>
          </select>
        </div>

        <div class="field inline">
          <div>
            <label>ç›®å‰åƒ¹æ ¼</label>
            <div id="currentPrice" style="font-size:15px;font-weight:600;">-</div>
          </div>
          <div>
            <label for="quantity">æ•¸é‡</label>
            <input type="number" id="quantity" min="1" step="1" value="10" />
          </div>
        </div>

        <div class="field inline">
          <button class="btn-buy" id="buyBtn">è²·é€²</button>
          <button class="btn-sell" id="sellBtn">è³£å‡º</button>
        </div>

        <button class="btn-start" id="startBtn">é–‹å§‹éŠæˆ²ï¼ˆ1 ç§’ä¸€æ ¹ Kï¼‰</button>
        <button class="btn-pause" id="pauseBtn" disabled>æš«åœ</button>
        <button class="btn-secondary" id="finishBtn">çµç®—ä¸¦æŸ¥çœ‹æ’è¡Œæ¦œ</button>

        <div id="message" class="hint"></div>

        <div class="stats">
          <div class="stat">
            <div class="stat-label">ç¾é‡‘é¤˜é¡</div>
            <div id="cash" class="stat-value"></div>
          </div>
          <div class="stat">
            <div class="stat-label">ç¸½è³‡ç”¢ï¼ˆç¾é‡‘ï¼‹æŒè‚¡ï¼‰</div>
            <div id="equity" class="stat-value"></div>
          </div>
          <div class="stat">
            <div class="stat-label">æœªå¯¦ç¾æç›Šï¼ˆä¼°ç®—ï¼‰</div>
            <div id="unrealized" class="stat-value"></div>
            <div id="unrealizedPct" class="stat-sub"></div>
          </div>
          <div class="stat">
            <div class="stat-label">å·²å¯¦ç¾æç›Š</div>
            <div id="realized" class="stat-value"></div>
            <div class="stat-sub">å¹³å‡æˆæœ¬æ³•ï¼šåªåœ¨ã€Œè³£å‡ºã€æ™‚è¨ˆå…¥</div>
          </div>
        </div>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>æ¨™çš„</th><th>æŒæœ‰æ•¸é‡</th><th>ç¾åƒ¹</th><th>å¸‚å€¼</th></tr>
            </thead>
            <tbody id="positionTableBody"></tbody>
          </table>
        </div>

        <div class="hint">ğŸ“Œ è¦å‰‡ï¼šæˆäº¤åƒ¹=æœ€æ–°æ”¶ç›¤åƒ¹ï¼›ç„¡æ»‘åƒ¹/æ‰‹çºŒè²»ï¼›ç´”åŠ‡æƒ…æŠ•è³‡ã€‚</div>

        <h2 style="margin-top:14px;">äº¤æ˜“ç´€éŒ„</h2>
        <div id="log" class="log"></div>
      </div>

      <div class="card">
        <div class="chart-header">
          <div class="chart-title"><span id="chartAssetName">æ–¹èˆŸé€ èˆ¹é›†åœ˜ï¼ˆARKZï¼‰</span> â€” K ç·šåœ–</div>
          <div class="price-text">ç›®å‰åƒ¹æ ¼ï¼š<span id="chartPriceText">-</span></div>
        </div>
        <canvas id="chart" width="700" height="380"></canvas>
        <div class="hint">
          é–‹å ´å…ˆæœ‰ 10 æ ¹ã€Œéš¨æ©Ÿæ­·å² Kã€(ä¸ç®—åŠ‡æƒ…)ã€‚é–‹å§‹å¾Œæ‰è·‘åŠ‡æƒ…ç¬¬ 1ï½100 æ ¹ã€‚  
          æ–°èæ¡ã€ŒåŒå¥åªæ¨ä¸€æ¬¡ã€ã€‚
        </div>

        <div class="news-box">
          <div class="news-title">ğŸ“¢ å¸‚å ´æ–°è</div>
          <div id="newsList"></div>
        </div>

        <div id="newsOverlay" class="news-overlay hidden">
          <div class="news-overlay-content" id="newsOverlayContent"></div>
        </div>
      </div>
    </div>

    <!-- éŠæˆ²å¾Œ -->
    <div id="screenPost" class="card screen hidden">
      <div class="lb-title">
        <h2 style="margin:0;">éŠæˆ²å¾Œï¼šæ’è¡Œæ¦œï¼ˆå…¨ç©å®¶å…±ç”¨ï¼‰</h2>
        <span class="pill" id="yourResultPill">-</span>
      </div>
      <div class="hint" style="margin-top:6px;">
        ä¾ã€Œç¸½è³‡ç”¢ã€æ’åºï¼›è³‡æ–™å„²å­˜åœ¨ Google Sheetsï¼ˆè·¨è£ç½®å¯è¦‹ï¼‰ã€‚åŒåæœƒæ›´æ–°ç‚ºæœ€æ–°æˆç¸¾ã€‚
      </div>

      <div class="table-wrapper" style="margin-top:12px;">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>ç©å®¶</th>
              <th>ç¸½è³‡ç”¢</th>
              <th>ç¸½æç›Š</th>
              <th>æ™‚é–“</th>
            </tr>
          </thead>
          <tbody id="leaderboardBody"></tbody>
        </table>
      </div>

      <button class="btn-start" id="playAgainBtn">å†ç©ä¸€æ¬¡ï¼ˆå›åˆ°è¼¸å…¥åç¨±ï¼‰</button>
      <button class="btn-secondary" id="backToGameBtn">å›åˆ°éŠæˆ²ï¼ˆä¸é‡ç½®ï¼‰</button>
      <div class="hint">æç¤ºï¼šä½ ä¹Ÿå¯ä»¥ç›´æ¥å›åˆ°éŠæˆ²ç¹¼çºŒç©ï¼Œå†çµç®—ä¸€æ¬¡æ›´æ–°æˆç¸¾ã€‚</div>
    </div>
  </div>

  <script>
    // âœ… ä½ çš„ Google Apps Script Web Appï¼ˆå·²éƒ¨ç½²ï¼‰
    // ç”¨ script.google.com é€™æ¢ï¼ˆä¸è¦ç”¨ googleusercontentï¼‰
    const LEADERBOARD_API_URL = "https://script.google.com/macros/s/AKfycbzCKXwMgcI3ihjR-XQ6NX8D3XkQESeafve10QqHmeP0k5AZ42XYdX05MXvv9GVAxBPx/exec";

    const ASSETS = [
      { id: "A", code: "ARKZ", name: "æ–¹èˆŸé€ èˆ¹é›†åœ˜ï¼ˆARKZï¼‰", initial: 100 },
      { id: "B", code: "WALL", name: "è€¶åˆ©å“¥åŸç‰†é˜²ç¦¦å…¬å¸ï¼ˆWALLï¼‰", initial: 90 },
      { id: "C", code: "WHALE", name: "ç´„æ‹¿æµ·åº•è§€å…‰æ§è‚¡ï¼ˆWHALEï¼‰", initial: 80 },
    ];

    const initialCash = 100000;
    let playerName = "";

    let cash = initialCash;
    let holdings = { A: 0, B: 0, C: 0 };
    let costBasis = { A: 0, B: 0, C: 0 };
    let realizedPnl = 0;

    let candles = { A: [], B: [], C: [] };
    let scriptIndex = { A: 0, B: 0, C: 0 };
    let sinBase1 = { A: null, B: null, C: null };
    let sinBase2 = { A: null, B: null, C: null };

    let newsHistory = { A: [], B: [], C: [] };
    const maxNews = 5;

    const maxCandlesToShow = 80;
    let currentAssetId = "A";

    let gameStarted = false;
    let gamePaused = false;
    let gameIntervalId = null;

    // ä¸‰ç•«é¢åˆ‡æ›
    const screenPre = document.getElementById("screenPre");
    const screenGame = document.getElementById("screenGame");
    const screenPost = document.getElementById("screenPost");

    function showScreen(which) {
      screenPre.classList.add("hidden");
      screenGame.classList.add("hidden");
      screenPost.classList.add("hidden");
      if (which === "pre") screenPre.classList.remove("hidden");
      if (which === "game") screenGame.classList.remove("hidden");
      if (which === "post") screenPost.classList.remove("hidden");
    }

    function formatMoney(num) {
      return num.toLocaleString("zh-TW", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    function randBetween(min, max) { return min + Math.random() * (max - min); }
    function clampPrice(p) { return Math.max(0.01, p); }
    function getLastPrice(assetId) {
      const arr = candles[assetId];
      if (!arr.length) return null;
      return arr[arr.length - 1].close;
    }

    // âœ… é›²ç«¯æ’è¡Œæ¦œï¼šGET å–æ¦œå–®ï¼ˆåŒæ¨£æœ€ç©©ï¼‰
    async function fetchLeaderboard() {
      const res = await fetch(LEADERBOARD_API_URL, { method: "GET" });
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || "Leaderboard fetch failed");
      return data.rows || [];
    }

    // âœ… æœ€ç©©ï¼šç”¨ GET query string ä¸Šå‚³ï¼ˆé¿å… CORS preflightï¼‰
    async function submitScore(name, equity) {
      const pnl = equity - initialCash;
      const ts = Date.now();
      const ua = "web";

      const url =
        LEADERBOARD_API_URL +
        `?action=submit&name=${encodeURIComponent(name)}` +
        `&equity=${encodeURIComponent(equity)}` +
        `&pnl=${encodeURIComponent(pnl)}` +
        `&ts=${encodeURIComponent(ts)}` +
        `&ua=${encodeURIComponent(ua)}`;

      const res = await fetch(url, { method: "GET" });
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || "Submit failed");
      return data.rows || [];
    }

    // ç®—ç¸½è³‡ç”¢
    function calcEquity() {
      let totalValue = 0;
      ASSETS.forEach(a => {
        const price = getLastPrice(a.id) || a.initial;
        totalValue += holdings[a.id] * price;
      });
      return cash + totalValue;
    }

    function renderLeaderboard(list) {
      const tbody = document.getElementById("leaderboardBody");
      tbody.innerHTML = "";
      if (!list.length) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="5" style="text-align:center;color:#9ca3af;">å°šç„¡ç´€éŒ„ï¼Œå¿«ä¾†æ¶ç¬¬ä¸€ï¼</td>`;
        tbody.appendChild(tr);
        return;
      }

      list.forEach((x, i) => {
        const tr = document.createElement("tr");
        const equity = Number(x.equity) || 0;
        const pnl = equity - initialCash;
        const ts = Number(x.ts) || 0;

        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${escapeHtml(x.name || "")}</td>
          <td>${formatMoney(equity)}</td>
          <td class="${pnl>=0 ? "pnl-positive":"pnl-negative"}">${pnl>=0?"+":""}${formatMoney(pnl)}</td>
          <td style="color:#9ca3af;">${ts ? new Date(ts).toLocaleString("zh-TW",{hour12:false}) : "-"}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    // åˆå§‹æ–°è
    function getInitialNews(code) {
      if (code === "ARKZ") return "ARKZï¼šé€ èˆ¹å» å®£å¸ƒã€ä»Šæ—¥å·¥å®‰é›¶äº‹æ•…ã€ï¼Œè‚¡æ°‘ï¼šé‚£â€¦æ˜å¤©å‘¢ï¼Ÿ";
      if (code === "WALL") return "WALLï¼šå…¬å¸æ¨å‡ºã€åŸç‰†å»¶é•·ä¿å›ºã€æ–¹æ¡ˆï¼Œæ¢æ¬¾å¯«ï¼šå€’äº†ä¸ç®—ã€‚";
      if (code === "WHALE") return "WHALEï¼šæ¨å‡ºã€åŒ…åƒåŒ…ä½ã€å¥—è£ï¼Œåƒä½åœ°é»ï¼šå—¯â€¦è‚šå­è£¡ã€‚";
      return "å¸‚å ´ä»Šæ—¥å¤šç©ºå¹³è¡¡ã€‚";
    }

    // åŠ‡æƒ…æ–°è
    function getNewsForARKZ(n) {
      if (n <= 15) return "å°ˆå®¶é æ¸¬æ´ªæ°´å³å°‡åˆ°ä¾†ï¼Œæ–¹èˆŸéœ€æ±‚å¢åŠ ï¼Œé€ èˆ¹è¨‚å–®æ’åˆ°æ˜å¹´ã€‚";
      if (n <= 25) return "ä¸€é™£æ±æ–¹ä¾†çš„é¢¨å°‡çƒé›²å¹æ•£ï¼Œå¸‚å ´èªç‚ºå±æ©Ÿè§£é™¤ï¼Œæ–¹èˆŸè¢«å¤§é‡æ‹‹å”®ã€‚";
      if (n <= 35) return "å¤©ç©ºçªç„¶é£„èµ·æ¯›æ¯›é›¨ï¼Œéƒ¨åˆ†ä¼æ¥­é–‹å§‹ä½æ¥æ–¹èˆŸï¼Œé€ èˆ¹å» é‡æ–°å•Ÿå‹•ç”¢ç·šã€‚";
      if (n <= 70) return "è±ªé›¨ç‰¹å ±ç™¼å¸ƒï¼Œæ‘©æ ¹å¤§é€šç™¼å¸ƒå ±å‘Šï¼šã€ALL IN æ–¹èˆŸã€ï¼Œè‚¡åƒ¹åŠ‡çƒˆæ“ºç›ªèµ°é«˜ã€‚";
      if (n <= 90) return "é›¨åœäº†ï¼Œä½†æ˜¯æ°´é‚„æ²’é€€ï¼ŒæŠ•è³‡äººçŒ¶è±«æ˜¯å¦é‚„è¦ç¹¼çºŒæŒæœ‰æ–¹èˆŸè‚¡ã€‚";
      if (n <= 95) return "é´¿å­é£›å‡ºå»æ²’æœ‰å›ä¾†ï¼Œå¸‚å ´ä¸€ç‰‡å®‰éœï¼Œæˆäº¤é‡é©Ÿé™ã€‚";
      return "ä¸Šå¸ä»¥å½©è™¹ç‚ºç´„å®šï¼Œä¸å†é™ä¸‹æ´ªæ°´ï¼Œæ–¹èˆŸç›¸é—œç”¢æ¥­é¢¨å…‰è½å¹•ã€‚";
    }
    function getNewsForWALL(n) {
      if (n <= 15) return "å„åœ‹ç·Šå¼µå±€å‹¢å‡æº«ï¼ŒåŸç‰†è¨‚å–®å¤§å¢ï¼Œé˜²ç¦¦è‚¡æˆç‚ºé¿éšªé¦–é¸ã€‚";
      if (n <= 25) return "åˆ†æå¸«ä¸Šèª¿è©•ç­‰ï¼šã€ç‰†è¶Šé«˜è¶Šå®‰å…¨ã€ï¼Œéš”å£åœ‹å®¶ï¼šä½ ç¢ºå®šï¼Ÿ";
      if (n <= 35) return "å¤–ä¾†æ°‘æ—æ¯å¤©ç¹åŸéŠè¡Œï¼Œå…¬å¸å›æ‡‰ï¼šã€åªæ˜¯å¥èµ°æ´»å‹•ï¼Œè«‹å‹¿ææ…Œã€‚ã€";
      if (n <= 70) return "ç¥­å¸å¹è™Ÿè§’æ¬¡æ•¸å±¢å‰µæ–°é«˜ï¼Œè‚¡åƒ¹åƒå¿ƒé›»åœ–ä¸€æ¨£ä¸Šä¸‹è·³ã€‚";
      if (n <= 90) return "ç‰†é¢ç–‘ä¼¼å‡ºç¾è£‚ç—•ç…§æµå‡ºï¼Œå…¬å¸è²æ˜ï¼šã€é‚£æ˜¯è£é£¾ç·šæ¢ã€‚ã€";
      if (n <= 95) return "ç¹åŸé€²å…¥ç¬¬ä¸ƒå¤©ï¼Œå¸‚å ´å±æ¯ï¼šåˆ°åº•æ˜¯ç‰†å€’ï¼Œé‚„æ˜¯æˆ‘å…ˆå€’ï¼Ÿ";
      return "è™Ÿè§’è²éŸ¿èµ·ï¼Œè€¶åˆ©å“¥åŸç‰†å…¨é¢å€’å¡Œï¼ŒWALL è‚¡åƒ¹ç¬é–“æš´è·Œæ­¸é›¶ã€‚";
    }
    function getNewsForWHALE(n) {
      if (n <= 15) return "æ·±æµ·ç™‚ç™’èˆªç·šé–‹å¹•ï¼Œä¸»æ‰“ã€ä¸‹æ½›å°±æ”¾ä¸‹ã€ï¼Œå®¢äººï¼šæˆ‘å…ˆæ”¾ä¸‹æˆ‘çš„éŒ¢ã€‚";
      if (n <= 25) return "æš´é¢¨å‚³èæ“´æ•£ï¼Œç¤¾ç¾¤æ´—ç‰ˆï¼šã€é€™è¶Ÿæœ‰é»åƒåœ¨é€ƒå‘½ã€ã€‚";
      if (n <= 35) return "å®‰å…¨çˆ­è­°çˆ†ç™¼ï¼šæœ‰äººè¢«ä¸Ÿä¸‹æµ·ï¼Ÿå…¬å¸æ¾„æ¸…ï¼šé‚£æ˜¯ã€è‡ªé¡˜ä¸‹æ°´é«”é©—ã€ã€‚";
      if (n <= 70) return "ã€è‚šå…§æ—…éŠã€çˆ†ç´…ï¼Œ#WhaleInside æŒ‘æˆ°å¸­æ²å…¨ç¶²ï¼Œå¹´è¼•äººç˜‹åˆ°ä¸è¡Œã€‚";
      if (n <= 90) return "ç›£ç®¡å‡ºæ‰‹é™åˆ¶æ¥µç«¯è¡Œç¨‹ï¼ŒWHALE æˆé•·å‹•èƒ½é™æº«ï¼Œè‚¡åƒ¹éœ‡ç›ªè¶¨ç·©ã€‚";
      if (n <= 95) return "ç´„æ‹¿å¹³å®‰ä¸Šå²¸æ•…äº‹ç¿»æ‹æˆç´€éŒ„ç‰‡ï¼Œè‚¡åƒ¹çŸ­æš«ç©©å®šï¼Œå¸‚å ´è§€æœ›è½‰å‹ã€‚";
      return "æ·±æµ·è§€å…‰é€€ç‡’ï¼Œå¤šæ•¸è³‡é‡‘æ’¤å‡ºï¼ŒWHALE è‚¡åƒ¹æš´è·Œï¼Œåªå‰©æµ·åº•å›éŸ³ã€‚";
    }

    // æ–°èï¼šåŒå¥åªæ¨ä¸€æ¬¡ï¼ˆæ¯æ¨™çš„ç¨ç«‹ï¼‰
    function addNewsOnce(assetId, text) {
      const list = newsHistory[assetId];
      if (!list.includes(text)) {
        list.unshift(text);
        if (list.length > maxNews) list.pop();

        if (assetId === currentAssetId && gameStarted) {
          showNewsOverlay(text);
        }
      }
    }

    function showNewsOverlay(text) {
      const overlay = document.getElementById("newsOverlay");
      const content = document.getElementById("newsOverlayContent");
      content.textContent = text;
      overlay.classList.remove("hidden");

      // æ–°èè·³å‡ºæ™‚è‡ªå‹•æš«åœ
      if (!gamePaused) {
        gamePaused = true;
        updatePauseButtonUI();
        setMessage("ğŸ“¢ é‡å¤§æ–°èï¼å¸‚å ´å·²è‡ªå‹•æš«åœï¼ŒæŒ‰ã€ç¹¼çºŒã€æ¢å¾©äº¤æ˜“ã€‚");
      }

      const close = () => overlay.classList.add("hidden");
      overlay.onclick = close;
      setTimeout(close, 2500);
    }

    function updateNewsUI() {
      const listEl = document.getElementById("newsList");
      const history = newsHistory[currentAssetId] || [];
      listEl.innerHTML = "";
      if (!history.length) { listEl.textContent = "å°šç„¡æ–°èã€‚"; return; }
      history.forEach((text, idx) => {
        const div = document.createElement("div");
        div.className = "news-item";
        const span = document.createElement("span");
        span.textContent = idx === 0 ? "æœ€æ–°" : "éå»";
        div.appendChild(span);
        div.appendChild(document.createTextNode(text));
        listEl.appendChild(div);
      });
    }

    // ===== åŠ‡æƒ…åƒ¹æ ¼è…³æœ¬ =====
    function generateARKZScript(n, open, assetId) {
      let close;
      const news = getNewsForARKZ(n);

      if (n <= 15) {
        let drift = randBetween(0.002, 0.006);
        if (Math.random() < 0.2) drift = randBetween(-0.002, 0.002);
        close = open * (1 + drift);
      } else if (n <= 25) {
        close = open * (1 + randBetween(-0.08, -0.03));
      } else if (n <= 35) {
        close = open * (1 + randBetween(-0.004, 0.01));
      } else if (n <= 70) {
        if (!sinBase1[assetId]) sinBase1[assetId] = open;
        const t = n - 36;
        const base = sinBase1[assetId] * (1 + 0.004 * t);
        const amp = 0.08;
        close = base * (1 + amp * Math.sin(t / 3));
      } else if (n <= 90) {
        if (!sinBase2[assetId]) sinBase2[assetId] = open;
        const t = n - 70;
        const base = sinBase2[assetId] * (1 - 0.003 * t);
        let amp = 0.06 * (1 - t / 20);
        if (amp < 0.02) amp = 0.02;
        close = base * (1 + amp * Math.sin(t / 2.5));
      } else if (n <= 95) {
        close = open * (1 + randBetween(-0.001, 0.001));
      } else {
        close = open * 0.2;
      }

      close = clampPrice(close);
      const highBase = Math.max(open, close);
      const lowBase = Math.min(open, close);
      const high = highBase * (1 + randBetween(0, 0.01));
      const low = clampPrice(lowBase * (1 - randBetween(0, 0.01)));
      return { open, high, low, close, news };
    }

    function generateWALLScript(n, open, assetId) {
      let close;
      const news = getNewsForWALL(n);

      if (n <= 15) close = open * (1 + randBetween(0.003, 0.007));
      else if (n <= 25) close = open * (1 + randBetween(0.01, 0.03));
      else if (n <= 35) close = open * (1 + randBetween(-0.03, 0.05));
      else if (n <= 70) {
        if (!sinBase1[assetId]) sinBase1[assetId] = open;
        const t = n - 36;
        const base = sinBase1[assetId] * (1 - 0.003 * t);
        const amp = 0.07;
        close = base * (1 + amp * Math.sin(t / 2.5));
      } else if (n <= 90) {
        if (!sinBase2[assetId]) sinBase2[assetId] = open;
        const t = n - 70;
        const base = sinBase2[assetId] * (1 - 0.004 * t);
        let amp = 0.05 * (1 - t / 20);
        if (amp < 0.015) amp = 0.015;
        close = base * (1 + amp * Math.sin(t / 2));
      } else if (n <= 95) close = open * (1 + randBetween(-0.005, 0.005));
      else close = open * 0.2;

      close = clampPrice(close);
      const highBase = Math.max(open, close);
      const lowBase = Math.min(open, close);
      const high = highBase * (1 + randBetween(0, 0.012));
      const low = clampPrice(lowBase * (1 - randBetween(0, 0.012)));
      return { open, high, low, close, news };
    }

    function generateWHALEScript(n, open, assetId) {
      let close;
      const news = getNewsForWHALE(n);

      if (n <= 15) close = open * (1 + randBetween(0.002, 0.006));
      else if (n <= 25) close = open * (1 + randBetween(-0.06, 0.06));
      else if (n <= 35) close = open * (1 + randBetween(-0.08, -0.03));
      else if (n <= 70) {
        if (!sinBase1[assetId]) sinBase1[assetId] = open;
        const t = n - 36;
        const base = sinBase1[assetId] * (1 + 0.003 * t);
        const amp = 0.10;
        close = base * (1 + amp * Math.sin(t / 2.5));
      } else if (n <= 90) {
        if (!sinBase2[assetId]) sinBase2[assetId] = open;
        const t = n - 70;
        const base = sinBase2[assetId] * (1 - 0.003 * t);
        let amp = 0.05 * (1 - t / 25);
        if (amp < 0.015) amp = 0.015;
        close = base * (1 + amp * Math.sin(t / 2));
      } else if (n <= 95) close = open * (1 + randBetween(-0.01, 0.01));
      else close = open * 0.4;

      close = clampPrice(close);
      const highBase = Math.max(open, close);
      const lowBase = Math.min(open, close);
      const high = highBase * (1 + randBetween(0, 0.015));
      const low = clampPrice(lowBase * (1 - randBetween(0, 0.015)));
      return { open, high, low, close, news };
    }

    function generateNextScriptCandle(assetId) {
      if (scriptIndex[assetId] >= 100) return;

      const asset = ASSETS.find(a => a.id === assetId);
      const arr = candles[assetId];
      const n = scriptIndex[assetId] + 1;

      const lastClose = arr.length ? arr[arr.length - 1].close : asset.initial;
      const open = lastClose;

      let result;
      if (asset.code === "ARKZ") result = generateARKZScript(n, open, assetId);
      else if (asset.code === "WALL") result = generateWALLScript(n, open, assetId);
      else result = generateWHALEScript(n, open, assetId);

      arr.push({ open: result.open, high: result.high, low: result.low, close: result.close, time: Date.now() });
      if (arr.length > maxCandlesToShow) arr.shift();

      scriptIndex[assetId] = n;
      addNewsOnce(assetId, result.news);

      if (scriptIndex.A >= 100 && scriptIndex.B >= 100 && scriptIndex.C >= 100) {
        stopTimer();
        setMessage("ä¸‰å€‹æ¨™çš„åŠ‡æƒ…éƒ½è·‘å®Œäº†ï¼ˆ100 æ ¹ï¼‰ï¼å¯ä»¥æŒ‰ã€Œçµç®—ä¸¦æŸ¥çœ‹æ’è¡Œæ¦œã€ã€‚");
      }
    }

    // 10 æ ¹éš¨æ©Ÿæ­·å²
    function generateRandomHistory(assetId, count) {
      const asset = ASSETS.find(a => a.id === assetId);
      let price = asset.initial;
      for (let i = 0; i < count; i++) {
        const open = price;
        const drift = randBetween(-0.01, 0.01);
        const close = clampPrice(open * (1 + drift));
        const highBase = Math.max(open, close);
        const lowBase = Math.min(open, close);
        const high = highBase * (1 + randBetween(0, 0.01));
        const low = clampPrice(lowBase * (1 - randBetween(0, 0.01)));
        candles[assetId].push({ open, high, low, close, time: Date.now() });
        price = close;
      }
    }

    function generateInitialData() {
      ASSETS.forEach(asset => {
        candles[asset.id] = [];
        scriptIndex[asset.id] = 0;
        sinBase1[asset.id] = null;
        sinBase2[asset.id] = null;
        newsHistory[asset.id] = [];

        generateRandomHistory(asset.id, 10);
        addNewsOnce(asset.id, getInitialNews(asset.code));
      });
    }

    // ===== ç¹ªåœ– =====
    function drawChart(assetId) {
      const canvas = document.getElementById("chart");
      const ctx = canvas.getContext("2d");
      const data = candles[assetId];
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (!data.length) return;

      const paddingLeft = 40, paddingRight = 20, paddingTop = 20, paddingBottom = 24;
      const plotWidth = canvas.width - paddingLeft - paddingRight;
      const plotHeight = canvas.height - paddingTop - paddingBottom;

      let minPrice = Infinity, maxPrice = -Infinity;
      data.forEach(c => { if (c.low < minPrice) minPrice = c.low; if (c.high > maxPrice) maxPrice = c.high; });
      if (maxPrice === minPrice) { maxPrice *= 1.01; minPrice *= 0.99; }
      const priceDiff = maxPrice - minPrice;

      ctx.save();
      ctx.strokeStyle = "#1f2937"; ctx.lineWidth = 1; ctx.setLineDash([4,4]);
      const gridLines = 4;
      for (let i = 0; i <= gridLines; i++) {
        const y = paddingTop + (plotHeight / gridLines) * i + (i === 0 ? 0.5 : 0);
        ctx.beginPath(); ctx.moveTo(paddingLeft, y); ctx.lineTo(canvas.width - paddingRight, y); ctx.stroke();
      }
      ctx.restore();

      ctx.fillStyle = "#6b7280"; ctx.font = "11px system-ui"; ctx.textAlign = "right"; ctx.textBaseline = "middle";
      for (let i = 0; i <= gridLines; i++) {
        const price = maxPrice - (priceDiff / gridLines) * i;
        const y = paddingTop + (plotHeight / gridLines) * i;
        ctx.fillText(price.toFixed(2), paddingLeft - 4, y);
      }

      const n = data.length;
      const barWidth = plotWidth / n;

      function priceToY(p) { return paddingTop + ((maxPrice - p) / priceDiff) * plotHeight; }

      for (let i = 0; i < n; i++) {
        const c = data[i];
        const x = paddingLeft + i * barWidth;
        const centerX = x + barWidth / 2;

        const yHigh = priceToY(c.high), yLow = priceToY(c.low), yOpen = priceToY(c.open), yClose = priceToY(c.close);
        const isBull = c.close >= c.open;
        const bodyTop = isBull ? yClose : yOpen;
        const bodyBottom = isBull ? yOpen : yClose;
        const bodyHeight = Math.max(2, bodyBottom - bodyTop);

        ctx.strokeStyle = isBull ? "#4ade80" : "#fb7185";
        ctx.lineWidth = 1.2;
        ctx.beginPath(); ctx.moveTo(centerX, yHigh); ctx.lineTo(centerX, yLow); ctx.stroke();

        ctx.fillStyle = isBull ? "#22c55e" : "#ef4444";
        ctx.fillRect(x + barWidth * 0.2, bodyTop, barWidth * 0.6, bodyHeight);
      }

      const lastPrice = data[data.length - 1].close;
      document.getElementById("chartPriceText").textContent = formatMoney(lastPrice);
    }

    // ===== UI =====
    function updatePortfolioUI() {
      const cashEl = document.getElementById("cash");
      const equityEl = document.getElementById("equity");
      const unrealizedEl = document.getElementById("unrealized");
      const unrealizedPctEl = document.getElementById("unrealizedPct");
      const realizedEl = document.getElementById("realized");
      const tbody = document.getElementById("positionTableBody");
      const currentPriceEl = document.getElementById("currentPrice");
      const chartAssetNameEl = document.getElementById("chartAssetName");

      let totalValue = 0;
      let totalCostBasis = 0;
      tbody.innerHTML = "";

      ASSETS.forEach(asset => {
        const price = getLastPrice(asset.id) || asset.initial;
        const qty = holdings[asset.id];
        const value = qty * price;
        totalValue += value;
        totalCostBasis += costBasis[asset.id];

        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${asset.name}</td><td>${qty}</td><td>${formatMoney(price)}</td><td>${formatMoney(value)}</td>`;
        tbody.appendChild(tr);
      });

      const equity = cash + totalValue;
      const unrealizedPnl = totalValue - totalCostBasis;
      const unrealizedPct = (unrealizedPnl / initialCash) * 100;

      cashEl.textContent = formatMoney(cash);
      equityEl.textContent = formatMoney(equity);

      unrealizedEl.textContent = formatMoney(unrealizedPnl);
      unrealizedEl.className = "stat-value " + (unrealizedPnl >= 0 ? "pnl-positive" : "pnl-negative");
      unrealizedPctEl.textContent = (unrealizedPnl >= 0 ? "+" : "") + unrealizedPct.toFixed(2) + " %";

      realizedEl.textContent = formatMoney(realizedPnl);
      realizedEl.className = "stat-value " + (realizedPnl >= 0 ? "pnl-positive" : "pnl-negative");

      const assetObj = ASSETS.find(a => a.id === currentAssetId);
      const lastPrice = getLastPrice(currentAssetId);

      currentPriceEl.textContent = lastPrice ? formatMoney(lastPrice) : "-";
      chartAssetNameEl.textContent = assetObj ? assetObj.name : currentAssetId;

      updateNewsUI();
    }

    function setMessage(text) { document.getElementById("message").textContent = text; }
    function setPreMessage(text) { document.getElementById("preMessage").textContent = text; }

    function addLogEntry(text) {
      const log = document.getElementById("log");
      const div = document.createElement("div");
      div.className = "log-entry";
      const time = new Date().toLocaleTimeString("zh-TW", { hour12: false });
      div.textContent = `[${time}] ${text}`;
      log.prepend(div);
    }

    // ===== äº¤æ˜“ =====
    function placeOrder(side) {
      const qtyInput = document.getElementById("quantity");
      let qty = Number(qtyInput.value);
      if (!Number.isFinite(qty) || qty <= 0) { setMessage("è«‹è¼¸å…¥å¤§æ–¼ 0 çš„æ•´æ•¸æ•¸é‡"); return; }
      qty = Math.floor(qty); qtyInput.value = qty;

      const price = getLastPrice(currentAssetId);
      if (price == null) { setMessage("ç›®å‰å°šç„¡åƒ¹æ ¼ï¼Œè«‹ç¨ç­‰ K ç·šç”Ÿæˆã€‚"); return; }

      if (side === "buy") {
        const cost = price * qty;
        if (cost > cash + 1e-6) { setMessage("ç¾é‡‘ä¸è¶³ï¼Œç„¡æ³•è²·é€²é€™éº¼å¤šæ•¸é‡ï¼"); return; }

        cash -= cost;
        holdings[currentAssetId] += qty;
        costBasis[currentAssetId] += cost;

        setMessage(`å·²ä»¥ ${formatMoney(price)} è²·é€² ${qty}ã€‚`);
        addLogEntry(`è²·é€² ${qty} å–®ä½ ${currentAssetId} @ ${formatMoney(price)}ï¼ˆèŠ±è²» ${formatMoney(cost)}ï¼‰`);
      } else {
        if (qty > holdings[currentAssetId]) { setMessage("æŒæœ‰æ•¸é‡ä¸è¶³ï¼Œç„¡æ³•è³£å‡ºé€™éº¼å¤šï¼"); return; }

        const revenue = price * qty;
        const held = holdings[currentAssetId];
        const avgCost = held > 0 ? (costBasis[currentAssetId] / held) : 0;
        const costOut = avgCost * qty;
        const realizedThis = revenue - costOut;

        cash += revenue;
        holdings[currentAssetId] -= qty;
        costBasis[currentAssetId] -= costOut;
        realizedPnl += realizedThis;
        if (holdings[currentAssetId] === 0) costBasis[currentAssetId] = 0;

        setMessage(`å·²ä»¥ ${formatMoney(price)} è³£å‡º ${qty}ã€‚`);
        addLogEntry(`è³£å‡º ${qty} å–®ä½ ${currentAssetId} @ ${formatMoney(price)}ï¼ˆæ”¶å…¥ ${formatMoney(revenue)}ï¼Œå·²å¯¦ç¾ ${formatMoney(realizedThis)}ï¼‰`);
      }

      updatePortfolioUI(); drawChart(currentAssetId);
    }

    // ===== Timer =====
    function startTimer() {
      if (gameIntervalId) return;
      gameIntervalId = setInterval(() => {
        if (!gameStarted) return;
        if (gamePaused) return;

        ASSETS.forEach(asset => generateNextScriptCandle(asset.id));
        updatePortfolioUI();
        drawChart(currentAssetId);
      }, 1000);
    }

    function stopTimer() {
      if (!gameIntervalId) return;
      clearInterval(gameIntervalId);
      gameIntervalId = null;
    }

    function updatePauseButtonUI() {
      const btn = document.getElementById("pauseBtn");
      if (!gameStarted) {
        btn.disabled = true;
        btn.textContent = "æš«åœ";
        btn.style.background = "#facc15";
        return;
      }
      btn.disabled = false;
      if (gamePaused) {
        btn.textContent = "ç¹¼çºŒ";
        btn.style.background = "#4ade80";
      } else {
        btn.textContent = "æš«åœ";
        btn.style.background = "#facc15";
      }
    }

    // âœ… é›²ç«¯çµç®—ï¼šé€å‡ºæˆç¸¾ + å–å¾—æœ€æ–°æ¦œå–®
    async function finishGame() {
      gamePaused = true;
      updatePauseButtonUI();
      stopTimer();

      const equity = calcEquity();
      const pnl = equity - initialCash;

      const entryName = playerName || "åŒ¿åç©å®¶";

      const finishBtn = document.getElementById("finishBtn");
      const oldText = finishBtn.textContent;
      finishBtn.disabled = true;
      finishBtn.textContent = "çµç®—ä¸­...";

      try {
        const list = await submitScore(entryName, equity);

        document.getElementById("yourResultPill").textContent =
          `ä½ ï¼ˆ${entryName}ï¼‰ï¼šç¸½è³‡ç”¢ ${formatMoney(equity)} ï½œç¸½æç›Š ${pnl>=0?"+":""}${formatMoney(pnl)}`;

        renderLeaderboard(list);
        showScreen("post");
      } catch (err) {
        console.error(err);
        setMessage("âŒ çµç®—/ä¸Šå‚³å¤±æ•—ï¼š" + (err?.message || "unknown"));
      } finally {
        finishBtn.disabled = false;
        finishBtn.textContent = oldText;
      }
    }

    function setupEvents() {
      document.getElementById("assetSelect").addEventListener("change", e => {
        currentAssetId = e.target.value;
        updatePortfolioUI();
        drawChart(currentAssetId);
      });

      document.getElementById("buyBtn").addEventListener("click", () => placeOrder("buy"));
      document.getElementById("sellBtn").addEventListener("click", () => placeOrder("sell"));

      document.getElementById("startBtn").addEventListener("click", () => {
        if (gameStarted) return;
        gameStarted = true;
        gamePaused = false;

        const startBtn = document.getElementById("startBtn");
        startBtn.disabled = true;
        startBtn.textContent = "éŠæˆ²é€²è¡Œä¸­...";

        updatePauseButtonUI();
        startTimer();
        setMessage("éŠæˆ²é–‹å§‹ï¼æ¯ç§’ä¸€æ ¹åŠ‡æƒ… Kã€‚æŒ‰ã€æš«åœã€å¯åœä½å¸‚å ´ã€‚");
      });

      document.getElementById("pauseBtn").addEventListener("click", () => {
        if (!gameStarted) { setMessage("éŠæˆ²å°šæœªé–‹å§‹ã€‚"); return; }
        gamePaused = !gamePaused;
        updatePauseButtonUI();
        setMessage(gamePaused ? "å·²æš«åœï¼ˆå¸‚å ´å†·éœä¸€ä¸‹ï¼‰ã€‚" : "ç¹¼çºŒï¼ˆå¸‚å ´åˆé–‹å§‹æƒ…ç·’åŒ–äº†ï¼‰ã€‚");
      });

      document.getElementById("finishBtn").addEventListener("click", () => {
        if (!playerName) { setMessage("å°šæœªè¨­å®šç©å®¶åç¨±ã€‚"); return; }
        finishGame();
      });

      document.getElementById("playAgainBtn").addEventListener("click", async () => {
        resetGameState();
        showScreen("pre");
        try { renderLeaderboard(await fetchLeaderboard()); } catch {}
      });

      document.getElementById("backToGameBtn").addEventListener("click", () => {
        showScreen("game");
      });

      document.addEventListener("visibilitychange", () => {
        if (!gameStarted) return;
        if (document.hidden) {
          gamePaused = true;
          updatePauseButtonUI();
        }
      });

      document.getElementById("confirmNameBtn").addEventListener("click", async () => {
        const v = document.getElementById("playerNameInput").value.trim();
        if (!v) { setPreMessage("è«‹å…ˆè¼¸å…¥ç©å®¶åç¨±ã€‚"); return; }
        playerName = v.slice(0,16);
        setPreMessage("");

        showScreen("game");
        setMessage(`æ­¡è¿ ${playerName}ï¼å·²è¼‰å…¥ 10 æ ¹éš¨æ©Ÿæ­·å² Kã€‚æº–å‚™å¥½å¾ŒæŒ‰ã€é–‹å§‹éŠæˆ²ã€ã€‚`);

        // é€²éŠæˆ²æ™‚å…ˆæ‹‰ä¸€æ¬¡æ’è¡Œæ¦œï¼ˆå¯æ¸¬é€£ç·šï¼‰
        try { await fetchLeaderboard(); } catch (e) {}
      });
    }

    function resetGameState() {
      cash = initialCash;
      holdings = { A: 0, B: 0, C: 0 };
      costBasis = { A: 0, B: 0, C: 0 };
      realizedPnl = 0;

      candles = { A: [], B: [], C: [] };
      scriptIndex = { A: 0, B: 0, C: 0 };
      sinBase1 = { A: null, B: null, C: null };
      sinBase2 = { A: null, B: null, C: null };

      newsHistory = { A: [], B: [], C: [] };
      currentAssetId = "A";
      document.getElementById("assetSelect").value = "A";

      gameStarted = false;
      gamePaused = false;
      stopTimer();

      const startBtn = document.getElementById("startBtn");
      startBtn.disabled = false;
      startBtn.textContent = "é–‹å§‹éŠæˆ²ï¼ˆ1 ç§’ä¸€æ ¹ Kï¼‰";

      document.getElementById("log").innerHTML = "";

      generateInitialData();
      updatePortfolioUI();
      drawChart(currentAssetId);
      updatePauseButtonUI();
    }

    function init() {
      generateInitialData();
      setupEvents();
      updatePortfolioUI();
      drawChart(currentAssetId);
      updatePauseButtonUI();

      showScreen("pre");

      // é è¼‰æ’è¡Œæ¦œï¼ˆè‹¥æœ‰éŒ¯æœƒåœ¨ console çœ‹åˆ°ï¼‰
      fetchLeaderboard().then(renderLeaderboard).catch(() => {});
    }

    window.addEventListener("load", init);
  </script>
</body>
</html>
